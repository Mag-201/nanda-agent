<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>Stock Agent â€” Web UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0b1220;--panel:#121a2b;--muted:#8aa0c8;--text:#e9f0ff;--accent:#3aa3ff;--bubble:#18233a;--me:#1f2d4d;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Helvetica Neue,Arial}
    .app{display:grid;grid-template-columns:280px 1fr;height:100vh}
    .left{background:var(--panel);border-right:1px solid #223154;display:flex;flex-direction:column}
    .brand{padding:16px 16px 8px;font-weight:700;letter-spacing:.5px}
    .status{padding:0 16px 12px;color:var(--muted);font-size:12px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;margin-left:6px}
    .ok{background:#153a25;color:#7df2a9}
    .bad{background:#3a1520;color:#ff8aa5}
    .sec{padding:12px 16px;border-top:1px solid #223154}
    .sec h3{margin:0 0 10px 0;font-size:13px;color:#b7c6e9;text-transform:uppercase;letter-spacing:.6px}
    .quick{display:flex;flex-wrap:wrap;gap:8px}
    .quick button{background:#16243f;border:1px solid #27406e;color:#cfe2ff;border-radius:10px;padding:8px 10px;font-size:13px;cursor:pointer}
    .quick button:hover{border-color:var(--accent)}
    .right{display:flex;flex-direction:column}
    .top{padding:12px 16px;border-bottom:1px solid #223154;display:flex;gap:8px;align-items:center}
    .top button{background:#16243f;border:1px solid #27406e;color:#cfe2ff;border-radius:10px;padding:8px 10px;font-size:13px;cursor:pointer}
    .chat{flex:1;overflow:auto;padding:18px}
    .row{display:flex;margin:8px 0;gap:10px}
    .row.me{justify-content:flex-end}
    .bubble{max-width:70%;background:var(--bubble);padding:12px 14px;border-radius:14px;line-height:1.4;white-space:pre-wrap}
    .me .bubble{background:var(--me)}
    .meta{font-size:11px;color:#9ab1da;margin-top:2px}
    .input{display:flex;gap:10px;padding:12px 16px;border-top:1px solid #223154}
    .input input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid #27406e;background:#0c1426;color:#e9f0ff;font-size:15px}
    .input button{padding:12px 16px;border-radius:12px;border:1px solid #27406e;background:var(--accent);color:#001428;font-weight:700;cursor:pointer}
    a.link{color:#9fd0ff;text-decoration:none}
    .small{font-size:12px;color:#9ab1da}
  </style>
</head>
<body>
<div class="app">
  <!-- å·¦ä¾§ï¼šçŠ¶æ€ & å¿«æ·é—®é¢˜ -->
  <aside class="left">
    <div class="brand">Stock Agent æ§åˆ¶é¢æ¿</div>
    <div class="status small">
      API: <a class="link" id="apiLink" target="_blank" rel="noreferrer"></a><br/>
      è¿æ¥ï¼š<span id="healthBadge" class="pill bad">æ£€æµ‹ä¸­â€¦</span><br/>
      ä¼šè¯IDï¼š<span id="cid" class="small">ï¼ˆè‡ªåŠ¨åˆ†é…ï¼‰</span>
    </div>

    <div class="sec">
      <h3>è‚¡ç¥¨å¸¸ç”¨æé—®</h3>
      <div class="quick">
        <button data-msg="What's the current price of AAPL?">AAPL ä»·æ ¼</button>
        <button data-msg="Give me today's top news about TSLA, bullet points.">TSLA æ–°é—»</button>
        <button data-msg="Compare NVDA vs AMD on valuation and growth in 5 bullets.">NVDA vs AMD</button>
        <button data-msg="Explain the main risks for buying Coinbase (COIN) now.">COIN é£é™©</button>
        <button data-msg="Show me a simple outlook for S&P 500 this week.">æ ‡æ™®å±•æœ›</button>
        <button data-msg="@stock help">æŒ‡ä»¤å¸®åŠ©</button>
      </div>
    </div>

    <div class="sec">
      <h3>å°æç¤º</h3>
      <div class="small">
        Â· è¿™é‡Œæ˜¯å‰ç«¯ï¼Œ**ä¸å†…ç½®è¡Œæƒ…**ï¼Œåªæ˜¯æŠŠä½ çš„é—®é¢˜å‘ç»™åç«¯çš„ Agentã€‚<br/>
        Â· å¦‚æœä½ çš„ Agent æ”¯æŒç‰¹æ®ŠæŒ‡ä»¤ï¼ˆå¦‚ <code>@stock</code>ã€<code>/quote</code>ï¼‰ï¼Œç›´æ¥åœ¨è¾“å…¥æ¡†é‡Œç”¨ã€‚<br/>
        Â· è¦æ”¹â€œè‚¡ç¥¨é€»è¾‘â€ï¼Œè¯·åœ¨ <code>agent_bridge.py</code> æˆ– Agent å¤„ç†ä»£ç é‡Œå®ç°ã€‚
      </div>
    </div>
  </aside>

  <!-- å³ä¾§ï¼šèŠå¤© -->
  <main class="right">
    <div class="top">
      <button id="newChat">æ–°å»ºä¼šè¯</button>
      <span class="small">æ–°å»ºåä¼šç”Ÿæˆæ–°çš„ <code>conversation_id</code>ï¼Œç”¨äºå¤šè½®ä¸Šä¸‹æ–‡ã€‚</span>
    </div>

    <div id="chat" class="chat"></div>

    <div class="input">
      <input id="msg" placeholder="é—®æˆ‘ï¼š'AAPL ç°åœ¨å¤šå°‘é’±ï¼Ÿ' æˆ– '@stock news TSLA' ..." />
      <button id="send">å‘é€</button>
    </div>
  </main>
</div>

<script>
  // â€”â€”â€” é…ç½®ï¼šæ”¹æˆä½ çš„ Cloudflare å…¬ç½‘åœ°å€ â€”â€”â€”
  const API_BASE = "https://deutsch-sparc-provision-police.trycloudflare.com";

  // â€”â€” åŸºæœ¬å…ƒç´ 
  const apiLink = document.getElementById('apiLink');
  const healthBadge = document.getElementById('healthBadge');
  const cidEl = document.getElementById('cid');
  const chatEl = document.getElementById('chat');
  const msgEl = document.getElementById('msg');
  const sendBtn = document.getElementById('send');
  const newBtn = document.getElementById('newChat');

  apiLink.textContent = API_BASE;
  apiLink.href = API_BASE + "/api/health";

  // â€”â€” ä¼šè¯IDï¼šæœ¬åœ°æŒä¹…åŒ–
  let conversationId = localStorage.getItem('conversation_id') || "";
  let agentId = "";

  function setCid(id){
    conversationId = id || "";
    cidEl.textContent = conversationId ? conversationId : "ï¼ˆè‡ªåŠ¨åˆ†é…ï¼‰";
    if (conversationId) localStorage.setItem('conversation_id', conversationId);
  }
  setCid(conversationId);

  // â€”â€” æ¸²æŸ“ä¸€æ¡æ¶ˆæ¯
  function bubble(role, text){
    const row = document.createElement('div');
    row.className = 'row ' + (role === 'me' ? 'me' : 'bot');
    const b = document.createElement('div');
    b.className = 'bubble';
    b.textContent = text;
    row.appendChild(b);
    chatEl.appendChild(row);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  // â€”â€” å‘é€
  async function send(){
    const text = msgEl.value.trim();
    if(!text) return;
    bubble('me', text);
    msgEl.value = '';

    try{
      const res = await fetch(API_BASE + "/api/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: text,
          client_id: "web_ui",
          conversation_id: conversationId || undefined
        })
      });
      const data = await res.json();
      if(!res.ok || data.error){
        bubble('bot', "âš ï¸ å‘é€å¤±è´¥ï¼š" + (data.error || res.statusText));
        return;
      }
      if (data.conversation_id && data.conversation_id !== conversationId){
        setCid(data.conversation_id);
      }
      if (data.agent_id) agentId = data.agent_id;
    }catch(e){
      bubble('bot', "âš ï¸ è¯·æ±‚å¼‚å¸¸ï¼š" + e);
    }
  }

  // â€”â€” è½®è¯¢æ‹‰å–æœ€æ–°å›å¤ï¼ˆè¯»å–åå³æ¸…ç©ºï¼‰
  async function poll(){
    try{
      const res = await fetch(API_BASE + "/api/render", { cache: "no-store" });
      if(res.ok){
        const data = await res.json();
        if (data && data.message){
          bubble('bot', (data.sender_name || 'Agent') + "ï¼š\n" + data.message);
          // å¦‚æœåç«¯å›ä¼ äº† conversation_idï¼Œä¹ŸåŒæ­¥ä¸€ä¸‹
          if (data.conversation_id && data.conversation_id !== conversationId){
            setCid(data.conversation_id);
          }
        }
      }
    }catch(e){
      // é™é»˜
    }finally{
      setTimeout(poll, 1000);
    }
  }

  // â€”â€” å¥åº·æ£€æŸ¥ï¼ˆçŠ¶æ€ç¯ï¼‰
  async function ping(){
    try{
      const r = await fetch(API_BASE + "/api/health", {cache:"no-store"});
      if(r.ok){
        const d = await r.json();
        healthBadge.textContent = "åœ¨çº¿";
        healthBadge.className = "pill ok";
        if (d && d.agent_id) agentId = d.agent_id;
      }else{
        throw new Error("HTTP " + r.status);
      }
    }catch{
      healthBadge.textContent = "ç¦»çº¿";
      healthBadge.className = "pill bad";
    }finally{
      setTimeout(ping, 4000);
    }
  }

  // â€”â€” å¿«æ·é—®é¢˜ç‚¹å‡»
  document.querySelectorAll('.quick button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      msgEl.value = btn.getAttribute('data-msg') || '';
      send();
    });
  });

  // â€”â€” äº‹ä»¶ç»‘å®š
  sendBtn.addEventListener('click', send);
  msgEl.addEventListener('keydown', e => { if(e.key === 'Enter') send(); });
  newBtn.addEventListener('click', ()=>{
    localStorage.removeItem('conversation_id');
    setCid("");
    bubble('bot', "ğŸ†• å¼€å§‹æ–°çš„ä¼šè¯ã€‚");
  });

  // â€”â€” å¯åŠ¨
  ping();
  poll();
</script>
</body>
</html>
